<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tensorflow · ml-tools</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="assets/documenter.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link href="assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>ml-tools</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="search.html"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="index.html">ML-Tools</a></li><li><a class="toctext" href="notebooks.html">Notebooks</a></li><li><span class="toctext">Docker</span><ul><li><a class="toctext" href="docker.html">Docker</a></li><li class="current"><a class="toctext" href="tensorflow.html">Tensorflow</a><ul class="internal"><li><a class="toctext" href="#Compilation-Overview-1">Compilation Overview</a></li><li><a class="toctext" href="#Building-tf-compiled-base-1">Building <code>tf-compiled-base</code></a></li><li><a class="toctext" href="#Building-tf-keras-1">Building <code>tf-keras</code></a></li></ul></li></ul></li><li><span class="toctext">Workloads</span><ul><li><a class="toctext" href="ubuntu.html">Ubuntu Workloads</a></li><li><a class="toctext" href="keras.html">Keras Models</a></li></ul></li><li><span class="toctext">Launcher</span><ul><li><a class="toctext" href="launcher.html">Launcher</a></li></ul></li></ul></nav><article id="docs"><header><nav><ul><li>Docker</li><li><a href="tensorflow.html">Tensorflow</a></li></ul><a class="edit-page" href="https://github.com/darchr/ml-tools/blob/master/docs/src/tensorflow.md"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>Tensorflow</span><a class="fa fa-bars" href="#"></a></div></header><h1><a class="nav-anchor" id="Tensorflow-1" href="#Tensorflow-1">Tensorflow</a></h1><p>We will use <a href="https://www.tensorflow.org/">Tensorflow</a> as one of the ML frameworks for  testing. Since the standard distribution for Tensorflow is not compiled with AVX2  instructions, I compiled Tensorflow from source on <code>amarillo</code>. The directory <code>tf-compile/</code> has the relevant files for how this is done.</p><p>The Docker Hub where the most current version of this container lives is here: <a href="https://hub.docker.com/r/darchr/tf-compiled-base/">https://hub.docker.com/r/darchr/tf-compiled-base/</a>. This repo will be kept  up-to-date as I make needed changes to the container.</p><p>I&#39;m using the official tensorflow docker approach to compile and build the pip package for tensor flow.</p><pre><code class="language-none">https://www.tensorflow.org/install/source
https://www.tensorflow.org/install/docker</code></pre><p>Helpful post talking about docker permissions <a href="https://denibertovic.com/posts/handling-permissions-with-docker-volumes/">https://denibertovic.com/posts/handling-permissions-with-docker-volumes/</a></p><h2><a class="nav-anchor" id="Compilation-Overview-1" href="#Compilation-Overview-1">Compilation Overview</a></h2><p>Containers will be build incrementally, starting with <code>darchr/tf-compiled-base</code>, which is the base image containing Tensorflow that has been compiled on <code>amarillo</code>. Compiling Tensorflow is important because the default Tensorflow binary is not compiled to use AVX2 instructions. Using the very scientific &quot;eyeballing&quot; approach, this compiled version of Tensorflow runs ~60% faster.</p><p>Other containers that use Tensorflow can be build from <code>darchr/tf-compiled/base</code>.</p><h2><a class="nav-anchor" id="Building-tf-compiled-base-1" href="#Building-tf-compiled-base-1">Building <code>tf-compiled-base</code></a></h2><p>As a high level overview, we use an official Tensorflow docker containers to build a  Python 3.5 &quot;wheel&quot; (package). We then use a Python 3.5.6 docker container as a base to  install the compiled tensorflow wheel.</p><h3><a class="nav-anchor" id="Compiling-Tensorflow-1" href="#Compiling-Tensorflow-1">Compiling Tensorflow</a></h3><p>Pull the docker container with the source code:</p><pre><code class="language-sh">docker pull tensorflow/tensorflow:1.10.0-devel-py3</code></pre><p>Launch the container with</p><pre><code class="language-sh">docker run -it -w /tensorflow -v $PWD:/mnt -e HOST_PERMS=&quot;$(id -u):$(id -g)&quot; tensorflow/tensorflow:1.10.0-devel-py3 bash</code></pre><p>This does the following:</p><ul><li><p>Opens the container in the <code>/tensorflow</code> directory, which contains the tensorflow source   code</p></li><li><p>Mounts the current directory into the <code>/mnt</code> directory in the container. This allows the   .whl build to be dropped in the PWD after compilation.</p></li></ul><p>Inside the container, run</p><pre><code class="language-sh">git pull</code></pre><p>to pull the latest copy of the tensorflow source. Then configure the build with</p><pre><code class="language-sh">./configure</code></pre><p>Settings used:</p><ul><li>Python Location: default</li><li>Python Library Path: default</li><li>jemalloc support: Y</li><li>Google cloud platform support: n</li><li>Hadoop file system support: n</li><li>Amazon AWS platform support: n</li><li>Apache Kafka Platform support: n</li><li>XLA Jis support: N</li><li>GDR support: N</li><li>VERBs support: N</li><li>nGraph support: N</li><li>OpenCL SYCL support: N</li><li>CUDA support: N</li><li>Fresh clang release: N</li><li>MPI support: N</li><li>Optimization flags: default</li><li>Interactively configure ./WORKSPACE: N</li></ul><p>Steps to build:</p><pre><code class="language-none">bazel build --config=opt //tensorflow/tools/pip_package:build_pip_package
./bazel-bin/tensorflow/tools/pip_package/build_pip_package /mnt
chown $HOST_PERMS /mnt/tensorflow-1.10.1-cp35-cp35m-linux_x86_64.whl</code></pre><p>Note, compilation takes quite a while, so be patient. If running on amarillo, enjoy the 96 thread awesomeness.</p><h4><a class="nav-anchor" id="Summary-1" href="#Summary-1">Summary</a></h4><pre><code class="language-sh">docker pull tensorflow/tensorflow:nightly-devel-py3
docker run -it -w /tensorflow -v $PWD:/mnt -e HOST_PERMS=&quot;$(id -u):$(id -g)&quot; tensorflow/tensorflow:nightly-devel-py3 bash
# inside container
git pull
./configure # Look at options above
bazel build --config=opt //tensorflow/tools/pip_package:build_pip_package
./bazel-bin/tensorflow/tools/pip_package/build_pip_package /mnt
chown $HOST_PERMS /mnt/tensorflow-1.10.1-cp35-cp35m-linux_x86_64.whl</code></pre><h3><a class="nav-anchor" id="Building-the-Docker-Image-1" href="#Building-the-Docker-Image-1">Building the Docker Image</a></h3><p>With the <code>.whl</code> for tensorflow build, we can build a new Docker container with this  installed. For this step, move <code>tensorflow-...-.whl</code> into the <code>tf-compiled-base/</code>  directory. Then, run the shell script:</p><pre><code class="language-sh">./build.sh tensorflow-1.10.1-cp35-cm35m-linux_x86_64.whl</code></pre><p>Finally, if necessary, push the image to the <code>darchr</code> docker hub via</p><pre><code class="language-sh">docker push darchr/tf-compiled-base</code></pre><h3><a class="nav-anchor" id="Details-1" href="#Details-1">Details</a></h3><p>Annoyingly, the <code>.whl</code> created in the previous step only works with Python 3.5. I tried  hacking it by changing the name (cp35-cp35m -&gt; cp36-cp36m), but installation with <code>pip</code>  failed. This means that we need a working copy of Python 3.5 in order to run this.  Fortunately, the Python foundation supplies Debian (I think ... or Ubuntu) based containers for past Python versions. We can use this as a starting point for our <code>Dockerfile</code>.</p><p>Permissions with the docker containers was becoming a bit of a nightmare. I finally found a solution that works by installing <code>gosu</code>:</p><ul><li><a href="https://github.com/tianon/gosu">https://github.com/tianon/gosu</a></li><li><a href="https://denibertovic.com/posts/handling-permissions-with-docker-volumes/">https://denibertovic.com/posts/handling-permissions-with-docker-volumes/</a></li></ul><p>Essentially, a dummy account <code>user</code> is created that does not have root privileges, but we can still create directories within the docker containers.</p><h2><a class="nav-anchor" id="Building-tf-keras-1" href="#Building-tf-keras-1">Building <code>tf-keras</code></a></h2><p>Just run the build script with:</p><pre><code class="language-sh">./build.sh</code></pre><footer><hr/><a class="previous" href="docker.html"><span class="direction">Previous</span><span class="title">Docker</span></a><a class="next" href="ubuntu.html"><span class="direction">Next</span><span class="title">Ubuntu Workloads</span></a></footer></article></body></html>
